{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Importa File Multipli da Media Manager{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a> &rsaquo;
    <a href="{% url 'admin:catalogo_cartelle_changelist' %}">Cartelle</a> &rsaquo;
    Importa File Multipli da Media Manager
</div>
{% endblock %}

{% block content %}
<form method="post" id="importForm">
    {% csrf_token %}
    
    <div class="card">
        <div class="card-header">
            <h1 class="mb-3">Importa File Multipli da Media Manager</h1>
            <p class="text-muted mb-0">
                Seleziona i file da Media Manager e assegnali a un catalogo. Puoi anche assegnarli a una categoria specifica.
            </p>
        </div>
        
        <div class="card-body">
            <!-- Selezione Catalogo e Categoria -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="catalogoSelect" class="font-weight-bold">
                            Catalogo <span class="text-danger">*</span>
                        </label>
                        <select name="catalogo_id" id="catalogoSelect" class="form-control" required>
                            <option value="">-- Seleziona Catalogo --</option>
                            {% for catalogo in cataloghi %}
                                <option value="{{ catalogo.id }}">{{ catalogo.nome_it }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="categoriaSelect" class="font-weight-bold">Categoria (opzionale)</label>
                        <select name="categoria_id" id="categoriaSelect" class="form-control" disabled>
                            <option value="">-- Prima seleziona un catalogo --</option>
                        </select>
                    </div>
                    
                </div>
                
            </div>

            <hr class="mb-4">

            <!-- Header con contatore e controlli -->
            <div class="row align-items-center mb-3">
                <div class="col-md-4">
                    <h4 class="mb-0">File Media Manager</h4>
                </div>
                <div class="col-md-5">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" id="searchInput" class="form-control" placeholder="Cerca file per nome...">
                    </div>
                </div>
                <div class="col-md-3 text-right">
                    <span class="badge badge-primary badge-lg mr-2" id="selectedCount">0 file selezionati</span>
                    <button type="submit" class="btn btn-success" id="importBtn" disabled>
                    <i class="fas fa-upload"></i> Importa Selezionati
                </button>
                </div>
            </div>

            <!-- Tabella file -->
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="filesTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" title="Seleziona/Deseleziona tutti">
                            </th>
                            <th style="width: 60px;">Anteprima</th>
                            <th>Nome File</th>
                            <th style="width: 120px;">Dimensione</th>
                            <th style="width: 150px;">Data Upload</th>
                            <th style="width: 150px;">Cartella Filer</th>
                        </tr>
                    </thead>
                    <tbody id="filesContainer">
                        {% for file in files %}
                        <tr class="file-item" data-filename="{% if file.label %}{{ file.label|lower }}{% elif file.original_filename %}{{ file.original_filename|lower }}{% elif file.name %}{{ file.name|lower }}{% else %}{{ file.file.name|lower }}{% endif %}">
                            <td class="text-center">
                                <input type="checkbox" name="file_ids" value="{{ file.id }}" class="file-checkbox">
                            </td>
                            <td class="text-center">
                                {% if file.file.name|slice:"-4:" == ".jpg" or file.file.name|slice:"-4:" == ".png" or file.file.name|slice:"-5:" == ".jpeg" or file.file.name|slice:"-4:" == ".gif" %}
                                    <img src="{{ file.url }}" alt="{{ file.name }}" class="img-thumbnail" style="max-width: 40px; max-height: 40px; object-fit: cover;">
                                {% else %}
                                    <span style="font-size: 24px; color: #6c757d;">
                                        {% if ".pdf" in file.file.name %}
                                            <i class="fas fa-file-pdf text-danger"></i>
                                        {% elif ".zip" in file.file.name or ".rar" in file.file.name %}
                                            <i class="fas fa-file-archive text-warning"></i>
                                        {% elif ".doc" in file.file.name or ".docx" in file.file.name %}
                                            <i class="fas fa-file-word text-primary"></i>
                                        {% elif ".xls" in file.file.name or ".xlsx" in file.file.name %}
                                            <i class="fas fa-file-excel text-success"></i>
                                        {% else %}
                                            <i class="fas fa-file"></i>
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>
                                    {% if file.label %}
                                        {{ file.label }}
                                    {% elif file.original_filename %}
                                        {{ file.original_filename }}
                                    {% elif file.name %}
                                        {{ file.name }}
                                    {% else %}
                                        File #{{ file.id }}
                                    {% endif %}
                                </strong>
                            </td>
                            <td>
                                {% if file.size %}
                                    {{ file.size|filesizeformat }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ file.uploaded_at|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if file.folder %}
                                    <span class="text-info">{{ file.folder.name }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="alert alert-info mb-0">
                                    Nessun file disponibile in Filer. Carica prima alcuni file nel Media Manager.
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
                <span class="badge badge-primary badge-lg" id="selectedCountBottom">0 selezionati</span>
            </div>
            <div>
                <a href="{% url 'admin:catalogo_cartelle_changelist' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Annulla
                </a>
                <button type="submit" class="btn btn-success" id="importBtn" disabled>
                    <i class="fas fa-upload"></i> Importa Selezionati
                </button>
            </div>
        </div>
    </div>
</form>

<style>
/* Stili minimi - lascia che Jazzmin gestisca il layout */
.card {
    margin-bottom: 0;
}

.card-header h1 {
    font-size: 1.75rem;
    font-weight: 600;
}

/* Tabella file - larghezza fissa */
.table-responsive {
    width: 100%;
    overflow-x: auto;
}

#filesTable {
    width: 100%;
    margin-bottom: 0;
    table-layout: fixed; /* Larghezza fissa delle colonne */
}

/* Larghezze fisse per ogni colonna */
#filesTable thead th:nth-child(1) { width: 40px; }   /* Checkbox */
#filesTable thead th:nth-child(2) { width: 60px; }   /* Anteprima */
#filesTable thead th:nth-child(3) { width: 35%; }    /* Nome File */
#filesTable thead th:nth-child(4) { width: 120px; }  /* Dimensione */
#filesTable thead th:nth-child(5) { width: 150px; }  /* Data */
#filesTable thead th:nth-child(6) { width: 200px; }  /* Cartella */

#filesTable tbody td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Permetti wrapping solo per il nome file */
#filesTable tbody td:nth-child(3) {
    white-space: normal;
    word-break: break-word;
}

#filesTable thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10;
}

#filesTable tbody tr {
    transition: background-color 0.2s;
}

#filesTable tbody tr:hover {
    background-color: #f8f9fa;
}

#filesTable tbody tr.selected {
    background-color: #d4edda;
}

.file-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #28a745;
}

#selectAllCheckbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #28a745;
}

.badge-lg {
    font-size: 1rem;
    padding: 0.5rem 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    #filesTable {
        font-size: 0.875rem;
    }
    
    #filesTable th, #filesTable td {
        padding: 0.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorieData = {{ categorie_json|safe }};
    
    const catalogoSelect = document.getElementById('catalogoSelect');
    const categoriaSelect = document.getElementById('categoriaSelect');
    const searchInput = document.getElementById('searchInput');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    const importBtn = document.getElementById('importBtn');
    const importBtnTop = document.getElementById('importBtnTop');
    const selectedCount = document.getElementById('selectedCount');
    const selectedCountBottom = document.getElementById('selectedCountBottom');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectNoneBtn = document.getElementById('selectNoneBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    // Gestione cambio catalogo
    catalogoSelect.addEventListener('change', function() {
        const catalogoId = this.value;
        categoriaSelect.innerHTML = '<option value="">-- Nessuna categoria --</option>';
        
        if (catalogoId && categorieData[catalogoId]) {
            categoriaSelect.disabled = false;
            categorieData[catalogoId].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nome;
                categoriaSelect.appendChild(option);
            });
        } else {
            categoriaSelect.disabled = true;
            categoriaSelect.innerHTML = '<option value="">-- Prima seleziona un catalogo --</option>';
        }
        
        updateImportButton();
    });
    
    // Gestione checkbox singola
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        
        checkbox.addEventListener('change', function() {
            updateRowSelection(row, this.checked);
            updateCounter();
            updateImportButton();
            updateSelectAllCheckbox();
        });
        
        // Click sulla riga
        row.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox' && !e.target.closest('a')) {
                checkbox.checked = !checkbox.checked;
                updateRowSelection(row, checkbox.checked);
                updateCounter();
                updateImportButton();
                updateSelectAllCheckbox();
            }
        });
    });
    
    // Checkbox "Seleziona tutti" nell'header
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
                return cb.closest('.file-item').style.display !== 'none';
            });
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                updateRowSelection(checkbox.closest('tr'), this.checked);
            });
            
            updateCounter();
            updateImportButton();
        });
    }
    
    // Ricerca file
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        document.querySelectorAll('.file-item').forEach(item => {
            const filename = item.getAttribute('data-filename');
            if (filename.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
        updateCounter();
        updateSelectAllCheckbox();
    });
    
    // Funzioni helper
    function updateRowSelection(row, isSelected) {
        if (isSelected) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    }
    
    function updateCounter() {
        const visibleChecked = Array.from(checkboxes).filter(cb => {
            return cb.checked && cb.closest('.file-item').style.display !== 'none';
        }).length;
        
        selectedCount.textContent = visibleChecked + ' file selezionati';
        selectedCountBottom.textContent = visibleChecked + ' selezionati';
    }
    
    function updateSelectAllCheckbox() {
        if (!selectAllCheckbox) return;
        
        const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
            return cb.closest('.file-item').style.display !== 'none';
        });
        
        const allChecked = visibleCheckboxes.length > 0 && 
                          visibleCheckboxes.every(cb => cb.checked);
        
        selectAllCheckbox.checked = allChecked;
    }
    
    function updateImportButton() {
        const catalogoSelected = catalogoSelect.value !== '';
        const filesSelected = document.querySelectorAll('.file-checkbox:checked').length > 0;
        const shouldEnable = catalogoSelected && filesSelected;
        
        importBtn.disabled = !shouldEnable;
        importBtnTop.disabled = !shouldEnable;
    }
});
</script>
{% endblock %}